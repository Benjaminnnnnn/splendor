Let’s be methodical. Please implement an AchievementService in TypeScript backed by SQLite (tables: achievements, achievement_criteria, user_stats, user_achievements). Achievement rows carry code, name, description, category, icon, unlock_type ('threshold' | 'ratio' | 'composite'), sort_order, timestamps. Criteria rows: stat_key, comparator ('>=', '<=', '>', '<', '='), target_value, optional denominator_stat_key, optional min_sample_size. user_stats holds games_played, games_won, total_prestige_points, total_cards_purchased, total_nobles_acquired, fastest_win_time, highest_prestige_score, favorite_gem_type, virtual_currency. user_achievements keeps unlocked_at, progress_value, progress_detail. Provide a repository that loads achievements with criteria, loads user achievements, reads user stats, and inserts unlocked achievements transactionally.

Define service behavior: getUserAchievements(userId) → { unlocked: AchievementDto[], locked: AchievementDto[] } with DomainToDTO mapping and unlockedAt/progressValue when present. evaluateUserAchievements(userId) should fetch stats, validate numeric fields, AND all criteria: ratio (numerator/denominator with min_sample_size), composite, and boolean presence for favorite_gem_type. Once unlocked, never revoke. When unlocking, store progress_detail as JSON snapshot of stats. Return { newlyUnlocked, alreadyUnlocked }.

Add a catalog seeder using the shared achievementsCatalog (first_game, first_win, marathon_20, prestige_hunter, consistent_winner, etc.). Make it idempotent: upsert achievement rows and rewrite criteria rows, relying on UNIQUE(code) and indexes on code + user_achievements foreign keys.

Expose Express routes /api/users/:userId/achievements (GET) and /api/users/:userId/achievements/evaluate (POST), 400 on missing userId, 500 on server errors. Keep controller/service separation.

Frontend wiring: in userServiceClient, add evaluateUserAchievements POST and getUserAchievements GET; in getUserProfile, call evaluate first then fetch profile bits. In GamePage, after a game finishes, call evaluateUserAchievements for all logged-in players. ProfilePage should have stats/achievements tabs; achievements tab filters by category, shows unlocked vs locked, art, counts, badges, and uses achievementsCatalog metadata.

Review the current unit, integration, property, and e2e tests for achievements. What edge scenarios are missing? Please add edge-only tests: unit , invalid achievement rows (missing code/name/unlock_type), invalid criteria, stats rows with missing numeric fields, ratio with denominator zero or below min_sample_size, composite where favorite_gem_type is empty, already unlocked not reinserted, progress_value math for ratio/threshold. Integration/e2e , evaluate endpoint returns 400 on missing userId, 500 on invalid config, unlocking persists to user_achievements. Property-ish , random stat payloads never produce NaN progress_value and respect min_sample_size. Use in-memory DatabaseConnection for isolation.
